import { readFile } from 'node:fs/promises';
import { URL } from 'node:url';
import { env } from 'node:process';
import { Client } from 'tumblr.js';
import { assert } from 'chai';
import { test } from 'mocha';

describe('oauth1 write requests', () => {
  /** @type {Client} */
  let client;
  before(function () {
    if (
      !env.TUMBLR_OAUTH_CONSUMER_KEY ||
      !env.TUMBLR_OAUTH_CONSUMER_SECRET ||
      !env.TUMBLR_OAUTH_TOKEN ||
      !env.TUMBLR_OAUTH_TOKEN_SECRET
    ) {
      console.log('Must provide all Oauth1 environment variables');
      this.skip();
    }

    if (!env.CI) {
      console.warn(
        'This test suite uses the API to make changes. Modify the test suite to enabled it.',
      );
      this.skip();
    }

    client = new Client({
      consumer_key: env.TUMBLR_OAUTH_CONSUMER_KEY,
      consumer_secret: env.TUMBLR_OAUTH_CONSUMER_SECRET,
      token: env.TUMBLR_OAUTH_TOKEN,
      token_secret: env.TUMBLR_OAUTH_TOKEN_SECRET,
      returnPromises: true,
    });
  });

  test('creates a post', async () => {
    const userResp = await client.userInfo();

    assert.isOk(userResp);
    const blogName = userResp.user.blogs[0].name;

    assert.isOk(
      await client.createPost(blogName, {
        type: 'text',
        format: 'markdown',
        title: `Automated test post ${new Date().toISOString()}`,
        body: 'This post was automatically generated by the tumblr.js tests.\n\n[The official JavaScript client library for the Tumblr API.](https://github.com/tumblr/tumblr.js)',
        tags: `tumblr.js-test,tumblr.js-version-${client.version}`,
      }),
    );
  });

  describe('image post', () => {
    it('creates an image post with data64', async () => {
      const imageData = await readFile(new URL('../test/fixtures/image.jpg', import.meta.url), {
        encoding: 'base64',
      });
      const userResp = await client.userInfo();

      assert.isOk(userResp);
      const blogName = userResp.user.blogs[0].name;

      const res = await client.createPost(blogName, {
        type: 'photo',
        caption: `Arches National Park || Automated test post ${new Date().toISOString()}`,
        link: 'https://openverse.org/en-gb/image/38b9b781-390f-4fc4-929d-0ecb4a2985e3',
        data64: imageData,
        tags: `tumblr.js-test,tumblr.js-version-${client.version}`,
      });
      console.log({ res });
      assert.isOk(res);
    });
  });
});
